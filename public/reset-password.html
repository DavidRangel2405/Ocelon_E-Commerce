<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ocelon - Restablecer Contraseña">
    <title>Restablecer Contraseña - Ocelon</title>
    <link rel="icon" href="/images/Logo.jpg" type="image/jpg">
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/responsive-fixes.css">
    
    <!-- Toast Notifications -->
    <link rel="stylesheet" href="css/toast-notifications.css">
</head>
<body>
    <!-- Botón volver al inicio -->
    <div class="back-home">
        <a href="/">
            <i class="fas fa-arrow-left"></i>
            <span>Volver al Inicio</span>
        </a>
    </div>

    <!-- Contenedor principal -->
    <div class="login-container">
        <div class="login-card animate__animated animate__fadeInUp">
            <!-- Header -->
            <div class="login-header">
                <div class="login-logo">
                    <img src="images/Logo.jpg" alt="Ocelon Logo">
                </div>
                <h1 class="login-title">Restablecer Contraseña</h1>
                <p class="login-subtitle">Ingresa tu nueva contraseña</p>
            </div>

            <!-- Loading State -->
            <div id="loadingState" style="display: none; text-align: center; padding: 40px 0;">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="text-muted">Verificando token...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" style="display: none; text-align: center; padding: 20px 0;">
                <div class="text-danger mb-3">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px;"></i>
                </div>
                <h4 class="mb-3">Token Inválido o Expirado</h4>
                <p class="text-muted mb-4">El enlace de recuperación no es válido o ha expirado.</p>
                <a href="/login.html" class="btn btn-ocelon">
                    <i class="fas fa-arrow-left me-2"></i>
                    Volver al Login
                </a>
            </div>

            <!-- Success State -->
            <div id="successState" style="display: none; text-align: center; padding: 20px 0;">
                <div class="text-success mb-3">
                    <i class="fas fa-check-circle" style="font-size: 48px;"></i>
                </div>
                <h4 class="mb-3">¡Contraseña Actualizada!</h4>
                <p class="text-muted mb-4">Tu contraseña ha sido actualizada exitosamente.</p>
                <a href="/login.html" class="btn btn-ocelon">
                    <i class="fas fa-sign-in-alt me-2"></i>
                    Iniciar Sesión
                </a>
            </div>

            <!-- Mensajes de error/éxito -->
            <div class="error-message" id="errorMessage" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText"></span>
            </div>

            <!-- Formulario de Reset -->
            <form id="resetForm" style="display: none;" novalidate>
                <!-- Nueva Contraseña -->
                <div class="input-group-custom">
                    <input 
                        type="password" 
                        class="form-control" 
                        id="newPassword" 
                        placeholder="Nueva contraseña"
                        required
                        minlength="8"
                        aria-label="Nueva contraseña"
                    >
                    <i class="fas fa-lock input-icon"></i>
                    <button type="button" class="password-toggle" id="togglePassword1" aria-label="Mostrar contraseña">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>

                <!-- Confirmar Contraseña -->
                <div class="input-group-custom">
                    <input 
                        type="password" 
                        class="form-control" 
                        id="confirmPassword" 
                        placeholder="Confirmar contraseña"
                        required
                        minlength="8"
                        aria-label="Confirmar contraseña"
                    >
                    <i class="fas fa-lock input-icon"></i>
                    <button type="button" class="password-toggle" id="togglePassword2" aria-label="Mostrar contraseña">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>

                <!-- Requisitos de contraseña -->
                <div class="password-requirements mb-4">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        La contraseña debe tener al menos:
                    </small>
                    <ul class="mt-2" style="font-size: 0.875rem; color: #6c757d;">
                        <li id="req-length">
                            <i class="fas fa-circle" style="font-size: 6px; margin-right: 8px;"></i>
                            8 caracteres
                        </li>
                        <li id="req-match">
                            <i class="fas fa-circle" style="font-size: 6px; margin-right: 8px;"></i>
                            Las contraseñas deben coincidir
                        </li>
                    </ul>
                </div>

                <!-- Botón de Submit -->
                <button type="submit" class="btn btn-ocelon w-100 mb-3" id="resetBtn">
                    <i class="fas fa-key"></i>
                    <span>Actualizar Contraseña</span>
                </button>

                <!-- Link a Login -->
                <div class="text-center">
                    <a href="/login.html" class="text-muted">
                        <i class="fas fa-arrow-left me-1"></i>
                        Volver al inicio de sesión
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Toast Notifications -->
    <script src="js/toast-notifications.js"></script>
    
    <!-- Reset Password Script -->
    <script>
        // Elementos del DOM
        const resetForm = document.getElementById('resetForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const resetBtn = document.getElementById('resetBtn');
        const errorMessage = document.getElementById('errorMessage');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const successState = document.getElementById('successState');

        // Obtener token de URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Funciones de utilidad
        function showError(message) {
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorMessage.style.display = 'flex';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function setLoading(loading) {
            if (loading) {
                resetBtn.disabled = true;
                resetBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Actualizando...';
            } else {
                resetBtn.disabled = false;
                resetBtn.innerHTML = '<i class="fas fa-key me-2"></i><span>Actualizar Contraseña</span>';
            }
        }

        // Toggle password visibility
        document.getElementById('togglePassword1')?.addEventListener('click', function() {
            togglePasswordVisibility(newPasswordInput, this);
        });

        document.getElementById('togglePassword2')?.addEventListener('click', function() {
            togglePasswordVisibility(confirmPasswordInput, this);
        });

        function togglePasswordVisibility(input, button) {
            const type = input.type === 'password' ? 'text' : 'password';
            input.type = type;
            const icon = button.querySelector('i');
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        // Validación en tiempo real
        function validatePassword() {
            const password = newPasswordInput.value;
            const confirm = confirmPasswordInput.value;
            const reqLength = document.getElementById('req-length');
            const reqMatch = document.getElementById('req-match');

            // Validar longitud
            if (password.length >= 8) {
                reqLength.style.color = '#10b981';
                reqLength.querySelector('i').classList.remove('fa-circle');
                reqLength.querySelector('i').classList.add('fa-check-circle');
            } else {
                reqLength.style.color = '#6c757d';
                reqLength.querySelector('i').classList.remove('fa-check-circle');
                reqLength.querySelector('i').classList.add('fa-circle');
            }

            // Validar coincidencia
            if (confirm && password === confirm) {
                reqMatch.style.color = '#10b981';
                reqMatch.querySelector('i').classList.remove('fa-circle');
                reqMatch.querySelector('i').classList.add('fa-check-circle');
                confirmPasswordInput.classList.remove('is-invalid');
                confirmPasswordInput.classList.add('is-valid');
            } else if (confirm) {
                reqMatch.style.color = '#dc3545';
                reqMatch.querySelector('i').classList.remove('fa-check-circle');
                reqMatch.querySelector('i').classList.add('fa-times-circle');
                confirmPasswordInput.classList.remove('is-valid');
                confirmPasswordInput.classList.add('is-invalid');
            }
        }

        newPasswordInput.addEventListener('input', validatePassword);
        confirmPasswordInput.addEventListener('input', validatePassword);

        // Verificar token al cargar
        async function verifyToken() {
            if (!token) {
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`/api/auth/verify-reset-token?token=${token}`);
                const data = await response.json();

                loadingState.style.display = 'none';

                if (data.success) {
                    resetForm.style.display = 'block';
                    newPasswordInput.focus();
                } else {
                    errorState.style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
            }
        }

        // Submit del formulario
        resetForm?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // Validaciones
            if (newPassword.length < 8) {
                showError('La contraseña debe tener al menos 8 caracteres');
                newPasswordInput.focus();
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Las contraseñas no coinciden');
                confirmPasswordInput.focus();
                return;
            }

            setLoading(true);

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token,
                        newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resetForm.style.display = 'none';
                    successState.style.display = 'block';

                    // Redirigir después de 3 segundos o cerrar pestaña
                    setTimeout(() => {
                        // Intentar cerrar la pestaña primero
                        window.close();
                        
                        // Si no se pudo cerrar (porque no fue abierta por script), redirigir
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 500);
                    }, 3000);
                } else {
                    setLoading(false);
                    showError(data.message || 'Error al actualizar contraseña');
                }
            } catch (error) {
                console.error('Error:', error);
                setLoading(false);
                showError('Error de conexión. Por favor intenta de nuevo.');
            }
        });

        // Iniciar verificación
        window.addEventListener('DOMContentLoaded', verifyToken);
    </script>
</body>
</html>